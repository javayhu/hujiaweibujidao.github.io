<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <title>
       Head First Android Testing 2 &middot;  Hujiawei Bujidao
    </title>

    <meta name="generator" content="Hugo 0.16" />
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta property="og:title" content=" Head First Android Testing 2 &middot;  Hujiawei Bujidao" />
  	<meta property="og:site_name" content="Hujiawei Bujidao" />
  	<meta property="og:url" content="https://hujiaweibujidao.github.io/blog/2015/05/31/head-first-android-testing-2/" />

    
  	<meta property="og:type" content="article" />
    <meta property="og:article:published_time" content="2015-05-31T00:00:00Z" />
    
    <meta property="og:article:tag" content="android" />
    
    

    <meta name="description" content="Happy Coding &amp; Enjoy Living" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="https://hujiaweibujidao.github.io/images/favicon.ico">
	  <link rel="apple-touch-icon" href="https://hujiaweibujidao.github.io/images/apple-touch-icon.png" />
    <link rel="stylesheet" type="text/css" href="https://hujiaweibujidao.github.io/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="https://hujiaweibujidao.github.io/css/nav.css" />
    <link rel="stylesheet" type="text/css" href="https://hujiaweibujidao.github.io/css/hugo.css" />

    
    <link rel="stylesheet" type="text/css" href="https://hujiaweibujidao.github.io/css/highlight.css">
    
    <link rel="stylesheet" type="text/css" href="https://hujiaweibujidao.github.io/css/github-gist.css">
    
    <script src="https://hujiaweibujidao.github.io/js/highlight.js"></script>
    <script type="text/javascript">hljs.initHighlightingOnLoad();</script>

    
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400|Inconsolata" />

    
      
          <link href="https://hujiaweibujidao.github.io/index.xml" rel="alternate" type="application/rss+xml" title="Hujiawei Bujidao" />
      
      
    

    <link rel="canonical" href="https://hujiaweibujidao.github.io/blog/2015/05/31/head-first-android-testing-2/" />

    
</head>
<body class="nav-closed">

  <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        

        
            
            <li class="nav-opened" role="presentation">
            	<a href="https://hujiaweibujidao.github.io/">Blog</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="https://hujiaweibujidao.github.io/android">Android</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="https://hujiaweibujidao.github.io/python">Python</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="https://hujiaweibujidao.github.io/swift">Swift</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="https://hujiaweibujidao.github.io/about">About</a>
            </li>
        
    </ul>

    <h3 class="nav-title-tag">Tags</h3>
    <ul>
        <li class="nav-opened" role="presentation"><a href="https://hujiaweibujidao.github.io/tags/android/">android</a></li>
        <li class="nav-opened" role="presentation"><a href="https://hujiaweibujidao.github.io/tags/python/">python</a></li>
        <li class="nav-opened" role="presentation"><a href="https://hujiaweibujidao.github.io/tags/algorithm/">algorithm</a></li>
        <li class="nav-opened" role="presentation"><a href="https://hujiaweibujidao.github.io/tags/java/">java</a></li>
        <li class="nav-opened" role="presentation"><a href="https://hujiaweibujidao.github.io/tags/dev/">dev</a></li>
        <li class="nav-opened" role="presentation"><a href="https://hujiaweibujidao.github.io/tags/life/">life</a></li>
    </ul>

    
        <a class="subscribe-button icon-feed" href="https://hujiaweibujidao.github.io/index.xml">Subscribe</a>
    
</div>
<span class="nav-cover"></span>


 <div class="site-wrapper">




  <header class="main-header post-head" style="background-image: url(https://hujiaweibujidao.github.io/images/default.jpg)">
  

    <nav class="main-nav overlay clearfix">
    
        <a class="blog-logo" href="https://hujiaweibujidao.github.io/"><img src="https://hujiaweibujidao.github.io/images/logo.png" alt="Blog Logo" /></a>
    
    
        <a class="menu-button" href="#"><span class="burger">&#9776;</span><span class="word">Menu</span></a>
    
</nav>

    <div class="vertical">
        <div class="main-header-content inner">
            <h1 class="page-title">Head First Android Testing 2</h1>
            <h2 class="page-description">Hujiawei Bujidao</h2> <br/>
            
    <a class="bloglogo" href="https://github.com/hujiaweibujidao" target="_blank">
    <span class="icon-github" style="color:white;font-size:2em"></span>
    </a>
&nbsp;


    <a class="bloglogo" href="https://weibo.com/hujiaweiyinger" target="_blank">
        <span class="icon-twitter" style="color:white;font-size:2em"></span>
    </a>
&nbsp;




    <a class="bloglogo" href="https://www.linkedin.com/in/hujiaweibujidao" target="_blank">
        <span class="icon-linkedin" style="color:white;font-size:2em"></span>
    </a>
&nbsp;


        </div>
    </div>
</header>



<main class="content" role="main">
  <article class="post post">

    <header class="post-header">
        <h1 class="post-title">Head First Android Testing 2</h1>
        

        <section class="post-meta">
        
          <time class="post-date" datetime="2015-05-31T00:00:00Z">
            May 31, 2015
          </time>
        
        &nbsp;&nbsp;
         
          <span class="post-tag small"><a href="https://hujiaweibujidao.github.io/tags/android/">#android</a></span>
         
        </section>
        <br/>
    </header>

    <section class="post-content">
      <p>深入浅出Android测试教程 (2)</p>

<p>###第二部分 Instrumentation Tests</p>

<p>Instrumentation Tests又叫Device or Emulator Tests，即运行在设备或者模拟器上的测试。使用<code>AndroidJunitRunner</code>来运行，测试代码存放在<code>androidTest</code>目录下。</p>

<p>①Run on Device or Emulator
②Run With <code>AndroidJUnitRunner</code>
③Located <code>androidTest/</code> source set</p>

<p>使用它需要依赖Android Support Repository，所以需要通过SDK Manager下载最新版本的Support Repository。</p>

<p>参考网址<a href="http://developer.android.com/tools/testing-support-library/index.html">Testing Support Library</a>提到，以前用来做测试的<code>InstrumentationTestRunner</code> 类只支持Junit 3，而新的<code>AndroidJunitRunner</code>类支持Junit 4。</p>

<p>测试步骤：</p>

<p>(1)配置<code>build.gradle</code></p>

<p>其中<code>testInstrumentationRunner &quot;android.support.test.runner.AndroidJUnitRunner&quot;</code>一定要设置，否则可能会出现找不到测试的错误，另外，如果还是使用了其他的库依赖的话，也可以继续添加上去。<code>AndroidJUnitRunner</code>是一个功能很强大的测试工具类，支持以下几个特性：</p>

<p>①A new test runner for Android JUnit3/JUnit4 Support
②Instrumentation Registry
③Test Filtering
④Intent Monitoring/Stubbing
⑤Activity/Application Lifecycle Monitoring</p>

<pre><code class="language-java">apply plugin: 'com.android.application'
android { ...
       defaultConfig {
           ...
           testInstrumentationRunner ‘android.support.test.runner.AndroidJUnitRunner’
        }
}
dependencies {
        // AndroidJUnit Runner dependencies
        androidTestCompile 'com.android.support.test:runner:0.2'
        androidTestCompile 'org.hamcrest:hamcrest-library:1.1'
}
</code></pre>

<p>(2)配置<code>Builde Variants</code>，选择<code>Android Instrumentation Tests</code></p>

<p><img src="https://hujiaweibujidao.github.io/images/instrumentationtest_buildvariants.png" alt="image" /></p>

<p>(3)编写Instrumentation Test程序，放在<code>src/androidTest/java</code>目录下</p>

<p>类<code>ObjectUtil</code>还是和前面的Unit Test中一样，只是添加一个新的测试类</p>

<pre><code>import android.content.Context;
import android.support.test.InstrumentationRegistry;
import android.support.test.filters.RequiresDevice;
import android.support.test.runner.AndroidJUnit4;
import android.test.suitebuilder.annotation.SmallTest;

import org.junit.After;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;

import java.io.Serializable;

import polaris.util.ObjectUtil;

import static org.hamcrest.core.Is.is;
import static org.junit.Assert.assertNotNull;
import static org.junit.Assert.assertThat;

@RunWith(AndroidJUnit4.class)
@SmallTest
public class InstrumentationTestSample {

    Context mMockContext;

    ObjectUtil objectUtil;
    private static final String fileName = &quot;demo&quot;;

    @Before
    public void setUp() throws Exception {
        mMockContext = InstrumentationRegistry.getContext();
        objectUtil = new ObjectUtil(mMockContext);
    }

    @Test
    public void testNotNull() {//ok
        //can not find symbol class R
        //when(mMockContext.getString(R.string.app_name)).thenReturn(&quot;polaris&quot;);
        //assertThat(mMockContext.getString(R.string.app_name), is(&quot;polaris&quot;));

        assertNotNull(mMockContext);
        assertNotNull(objectUtil);
    }

    @Test
    public void testSaveAndLoad() {//fail
        User user = new User(1, &quot;hujiawei&quot;);
        objectUtil.save(user, fileName);

        user = (User) objectUtil.load(fileName);
        assertThat(user.name, is(&quot;hujiawei&quot;));
    }

    static class User implements Serializable {
        int id;
        String name;

        User(int id, String name) {
            this.id = id;
            this.name = name;
        }
    }

    @After
    public void tearDown() throws Exception {
    }

}
</code></pre>

<p>(4)配置测试的运行参数</p>

<p><img src="https://hujiaweibujidao.github.io/images/instrumentation_configuration.png" alt="image" /></p>

<p>(5)运行测试有两种方式，可以简单地和运行普通程序一样点击Run按钮，结果会显示在下面的Run视图窗口中，也可以在终端运行<code>./gradlew connectedAndroidTest</code>，结果将放在<code>/build/outputs/reports/androidTests/connected/</code>中，打开<code>index.html</code>文件即可。前者只运行当前测试的运行参数中配置的测试类和方法，而后者会检测整个项目中的所有Instrumentation Test并进行测试。</p>

<p><img src="https://hujiaweibujidao.github.io/images/instrumentation_run.png" alt="image" /></p>

<p><img src="https://hujiaweibujidao.github.io/images/instrumentation_html.png" alt="image" /></p>

<p><strong>Instrumentation Registry</strong></p>

<p>通过Instrumentation Registry我们可以获取很多Android运行状态下的组件。</p>

<p>You can use the <code>InstrumentationRegistry</code> class to access information related to your test run. This class includes the <code>Instrumentation</code> object, target app <code>Context</code> object, test app <code>Context</code> object, and the command line arguments passed into your test. This data is useful when you are writing tests using the UI Automator framework or when writing tests that have dependencies on the <code>Instrumentation</code> or <code>Context</code> objects.</p>

<pre><code>@Before
public void accessAllTheThings() {
  mArgsBundle = InstrumentationRegistry.getArguments();
  mInstrumentation = InstrumentationRegistry.getInstrumentation();
  mTestAppContext = InstrumentationRegistry.getContext();
  mTargetContext = InstrumentationRegistry.getTargetContext();
}
</code></pre>

<p><strong>￼Test Filters</strong></p>

<p>通过Test Filters我们可以指定测试时的最小SDK版本或者是否必须使用设备。</p>

<p><code>@RequiresDevice</code>: Specifies that the test should run only on physical devices, not on emulators.</p>

<p><code>@SdkSupress</code>: Suppresses the test from running on a lower Android API level than the given level. For example, to suppress tests on all API levels lower than 18 from running, use the annotation @SDKSupress(minSdkVersion=18).</p>

<p><code>@SmallTest</code>, <code>@MediumTest</code>, and <code>@LargeTest</code>: Classify how long a test should take to run, and consequently, how frequently you can run the test.</p>

<pre><code>@SdkSuppress(minSdkVersion=15)
@Test
public void featureWithMinSdk15() {
...
}

@RequiresDevice
@Test
public void SomeDeviceSpecificFeature() {
...
}
</code></pre>

<p>可以看出Instrumentation Test的功能还是很强大的，这里只是冰山一角，感兴趣可以继续阅读更多的资料去学习，Enjoy it！</p>

    </section>

    <footer class="post-footer">
      
        <figure class="author-image">
            <a class="img" href="https://hujiaweibujidao.github.io/" style="background-image: url(https://hujiaweibujidao.github.io/images/logo.png)"><span class="hidden">hujiawei's Picture</span></a>
        </figure>
      

      





<section class="author" style="width:100%;">
  <div class="author-meta" style="width:100%;text-align:center;">
    <span class="author-location icon-user"> Hujiawei is an Android Developer.</span>
    <span class="author-location icon-location"> Guangdong, China</span>
    <span class="author-link icon-link"><a href="https://github.com/hujiaweibujidao"> https://github.com/hujiaweibujidao</a></span>
    <span class="author-profile" style="width:100%;"><strong>本博客所有文章均为原创，请勿随意转载，如需转载请联系我 (<a href="mailto:hujiawei090807@gmail.com">hujiawei090807 AT gmail.com</a>)</strong></span>
  </div>
</section>


      
        <aside class="read-next">
  
      <span class="readmore-prev readmore-meta">PREV: <a href="https://hujiaweibujidao.github.io/blog/2015/05/30/head-first-android-testing-1/"><h4>Head First Android Testing 1</h4></a></span>
      
  

  
      <span class="readmore-next readmore-meta">NEXT: <a href="https://hujiaweibujidao.github.io/blog/2015/05/31/android-universal-image-loader/"><h4>Android Universal Image Loader</h4></a></span>
      
  
</aside>
<br/>

      
      


<div style="font-weight:bold;" class="ds-thread" data-thread-key="blog/2015/05/31/head-first-android-testing-2/" data-title="Head First Android Testing 2" data-url="https://hujiaweibujidao.github.io/blog/2015/05/31/head-first-android-testing-2/"></div>


<script type="text/javascript">
 var duoshuoQuery = {short_name:'hujiaweibujidao'};
   (function() {
     var ds = document.createElement('script');
     ds.type = 'text/javascript';ds.async = true;
     ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
     ds.charset = 'UTF-8';
     (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
   })();
</script>




    </footer>
</article>

</main>

    <footer class="site-footer clearfix">
        <a id="gotop" class="icon-arrow-up" href="#" title="back to top"></a>

        <section class="copyright"><a href="">Hujiawei Bujidao. </a> All rights reserved &copy; 2016</section>
        
        <section class="poweredby">Proudly generated by <a href="http://gohugo.io">HUGO</a>, with <a class="icon-theme" href="https://github.com/vjeantet/hugo-theme-casper">Casper</a> theme &nbsp;
            
            <script type="text/javascript">
                var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
                document.write(unescape("%3Cspan id='cnzz_stat_icon_1000165127'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s22.cnzz.com/z_stat.php%3Fid%3D1000165127%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
            </script>
        </section>
        
    </footer>
  </div> 
    <script type="text/javascript" src="https://hujiaweibujidao.github.io/js/jquery.js"></script>
    <script type="text/javascript" src="https://hujiaweibujidao.github.io/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://hujiaweibujidao.github.io/js/index.js"></script>

    
    
    
    

    
</body>
</html>

